# Phase별 상세 가이드

> plan-task의 각 Phase 실행 세부 지침

---

## Phase 0: 규모 판단 (즉시 실행)

### 판단 기준

| 기준          | Small        | Medium         | Large          |
| ------------- | ------------ | -------------- | -------------- |
| 영향 범위     | 1개 모듈     | 2-3개 모듈     | 4개+ 모듈      |
| 예상 파일 수  | 1-3개        | 4-10개         | 10개+          |
| 데이터 변경   | 없음         | 기존 구조 확장 | 새 구조 추가   |
| 비즈니스 규칙 | 기존 규칙 내 | 경미한 추가    | 핵심 규칙 변경 |
| 사용자 흐름   | 변경 없음    | 기존 흐름 수정 | 새 흐름 추가   |
| 예상 공수     | ~10시간      | 20-50시간      | 50시간+        |

### Planning 경로 결정

```
Small:  Phase 1 → Phase 2 → Phase 5 → 완료
Medium: Phase 1 → Phase 2 → Phase 3 → Phase 5 → 완료
Large:  Phase 1 → Phase 2 → Phase 3 → Phase 4 → Phase 5 → 완료
```

### 출력 형식

```markdown
## 규모 판단

- **규모**: [Small/Medium/Large]
- **근거**:
  - 영향 범위: [모듈 수]
  - 데이터 변경: [있음/없음]
  - 비즈니스 규칙: [기존/추가/변경]
  - 사용자 흐름: [변경 없음/수정/추가]
- **Planning 경로**: Phase 1 → Phase 2 → ... → Phase 5
```

---

## Phase 1: 코드베이스 탐색 (필수)

### 목표

현재 코드베이스의 구조와 패턴을 파악하여 구현 방향을 결정합니다.

### Subagent 호출

```
Task tool:
  subagent_type: explore-codebase
  model: haiku
  prompt: |
    요청: [사용자 요청]

    다음을 파악해주세요:

    1. 프로젝트 구조
       - 디렉토리 구조
       - 기술 스택 (프레임워크, 라이브러리)
       - 빌드/테스트 도구

    2. 관련 파일 및 의존성
       - 수정이 필요한 파일 위치
       - 의존하는 모듈/컴포넌트
       - 참고할 기존 구현

    3. 코드 패턴과 컨벤션
       - 네이밍 규칙
       - 파일 구조 패턴
       - 에러 처리 방식
       - 테스트 작성 패턴

    4. 유사한 기존 구현
       - 참고할 만한 코드
       - 재사용 가능한 유틸리티
```

### 예상 결과

```markdown
## 프로젝트 구조

- 타입: [React/Next.js/FastAPI/...]
- 주요 디렉토리: src/, pages/, components/, ...

## 관련 파일

- 수정 필요: path/to/file.ts
- 의존성: path/to/dependency.ts

## 코드 패턴

- 컴포넌트: function 방식, TypeScript
- 상태 관리: React Context
- API 호출: axios wrapper

## 참고 구현

- 유사 기능: path/to/similar-feature.ts
```

---

## Phase 2: 요구사항 명확화 (필수)

### 목표

사용자 요청을 명확히 분석하고, **P0 모호함을 모두 제거**합니다.

### Subagent 호출

````
Task tool:
  subagent_type: clarify-requirements
  model: opus
  prompt: |
    [사용자 요청]
    [Phase 1 탐색 결과]

    다음을 수행하세요:

    ### 1. 요구사항 분석

    **명시적 요구사항** (사용자가 직접 언급)
    - [항목 1]
    - [항목 2]

    **암묵적 요구사항** (맥락에서 추론)
    - [항목 1]
    - [항목 2]

    **기술적 제약사항**
    - [제약 1]
    - [제약 2]

    ### 2. 모호함 분류 (P0~P3)

    | 등급 | 기준 | 처리 |
    |------|------|------|
    | P0 | 데이터 무결성, 보안, 금융, 핵심 비즈니스 | 즉시 질문 |
    | P1 | UX 분기, 비즈니스 디테일 | 기본값 + 나중에 확인 |
    | P2 | UI 디테일, 엣지케이스 | TODO로 기록 |
    | P3 | 기술 선택 | 자율 판단 |

    ### 3. P0 모호함 발견 시

    즉시 중단하고 질문 형식으로 정리:

    ```
    ## P0 모호함

    ### Q1: [질문 제목]
    - **맥락**: [왜 이 질문이 필요한가]
    - **질문**: [구체적인 질문]
    - **옵션**:
      A) [선택지 1] - [설명]
      B) [선택지 2] - [설명]
      C) 기타 (사용자 입력)
    ```
````

### P0 모호함 예시

**데이터 무결성:**

```
Q: 사용자가 중복 이메일로 가입 시도하면?
A) 기존 계정 연동 제안
B) 에러 메시지만 표시
C) 이메일 변경 요청
```

**보안:**

```
Q: 비밀번호 정책은?
A) 최소 8자, 영문+숫자
B) 최소 12자, 영문+숫자+특수문자
C) 외부 인증만 (OAuth)
```

**핵심 비즈니스:**

```
Q: 결제 실패 시 주문 상태는?
A) 즉시 취소
B) 30분 대기 후 취소
C) 수동 확인까지 보류
```

### 출력 형식

```markdown
## 요구사항 요약

[핵심 요구사항 3-5줄]

## 확인된 사항

### 명시적 요구사항

- [항목 1]
- [항목 2]

### 암묵적 요구사항

- [항목 1]
- [항목 2]

### 기술적 제약

- [제약 1]
- [제약 2]

## P0 모호함

[있으면 즉시 질문, 없으면 "없음"]

## P1/P2 미결정 사항

- [P1] 에러 메시지 문구 (나중에 UX 팀 검토)
- [P2] 버튼 색상 (디자인 가이드 적용)
```

---

## Phase 3: 사용자 여정 설계 (Medium/Large)

### 목표

사용자가 기능을 어떻게 사용하는지 전체 흐름을 설계합니다.

### Subagent 호출

````
Task tool:
  subagent_type: design-user-journey
  model: sonnet
  prompt: |
    [사용자 요청]
    [Phase 2 요구사항 결과]

    다음을 수행하세요:

    ### 1. 사용자 여정 정의

    **진입점**
    - 사용자가 이 기능에 어떻게 접근하는가?
    - 어떤 상태에서 시작하는가?

    **주요 흐름** (Happy Path)
    - 단계별 사용자 액션
    - 각 단계에서 시스템 응답

    **대안 흐름** (Alternative Paths)
    - 분기 조건
    - 분기 시 동작

    **종료점**
    - 성공 시 최종 상태
    - 실패 시 최종 상태

    ### 2. 상태 다이어그램

    ```
    [초기 상태]
         ↓
    [로딩 상태]
         ↓
    [성공] or [실패]
         ↓
    [최종 상태]
    ```

    ### 3. 에러 처리 전략

    | 에러 유형 | 처리 방법 | UX |
    |----------|----------|-----|
    | 네트워크 에러 | 재시도 | 재시도 버튼 |
    | 권한 에러 | 권한 요청 | 안내 메시지 + 설정 링크 |
    | 유효성 에러 | 즉시 피드백 | 실시간 검증 |
    | 서버 에러 | 로깅 + 안내 | 일반 에러 메시지 |
````

### 출력 형식

```markdown
## 사용자 여정

### 진입점

- [어디서, 어떻게 시작]

### 주요 흐름 (Happy Path)

1. [사용자 액션] → [시스템 응답]
2. [사용자 액션] → [시스템 응답]
3. [완료]

### 대안 흐름

- **분기 A**: [조건] → [동작]
- **분기 B**: [조건] → [동작]

### 종료점

- 성공: [최종 상태]
- 실패: [최종 상태]

## 상태 다이어그램
```

idle → loading → success/error → complete
↓
cancel → idle

```

## 에러 처리

| 에러 | 처리 | UX |
|-----|------|-----|
| 네트워크 | 3회 재시도 | "재시도" 버튼 |
| 권한 | 권한 요청 | "설정 열기" 링크 |
```

---

## Phase 4: 비즈니스 로직 정의 (Large)

### 목표

핵심 비즈니스 규칙을 명확히 정의합니다.

### Subagent 호출

```
Task tool:
  subagent_type: define-business-logic
  model: sonnet
  prompt: |
    [사용자 요청]
    [Phase 2 요구사항]
    [Phase 3 사용자 여정]

    다음을 수행하세요:

    ### 1. 비즈니스 규칙 식별

    5가지 규칙 유형으로 분류:

    - **VAL**: 유효성 검증 규칙
      - 입력값 검증
      - 데이터 형식 검증

    - **CALC**: 계산 규칙
      - 가격 계산
      - 포인트 계산
      - 수수료 계산

    - **STATE**: 상태 전이 규칙
      - 주문 상태 변경
      - 승인 프로세스

    - **AUTH**: 권한 규칙
      - 접근 권한
      - 작업 권한

    - **POL**: 정책 규칙
      - 할인 정책
      - 환불 정책

    ### 2. 규칙 명세화

    각 규칙에 대해:

    **규칙 ID**: CALC-001
    **조건**: [언제 적용되는가]
    **결과**: [무엇을 수행하는가]
    **예외**: [예외 상황]
    **예시**: [구체적 예시]
```

### 출력 형식

```markdown
## 비즈니스 규칙 목록

| ID        | 유형   | 설명               |
| --------- | ------ | ------------------ |
| VAL-001   | 유효성 | 이메일 형식 검증   |
| CALC-001  | 계산   | 할인 금액 계산     |
| STATE-001 | 상태   | 주문 완료 처리     |
| AUTH-001  | 권한   | 관리자만 삭제 가능 |
| POL-001   | 정책   | 7일 이내 환불      |

## 규칙 상세

### VAL-001: 이메일 형식 검증

- **조건**: 사용자가 이메일 입력 시
- **결과**: RFC 5322 표준 검증
- **예외**: 없음
- **예시**:
  - ✅ user@example.com
  - ❌ user@
  - ❌ @example.com

### CALC-001: 할인 금액 계산

- **조건**: 쿠폰 적용 시
- **결과**:
  - 할인율 적용: 금액 × (1 - 할인율)
  - 최소 금액: 1원
- **예외**:
  - 할인 후 0원 미만 → 1원
- **예시**:
  - 10,000원 × 10% = 9,000원
  - 100원 × 10% = 90원 (→ 90원)
```

---

## Phase 5: 구현 계획 수립 (필수)

### 목표

실제 구현을 위한 구체적인 작업 계획을 수립합니다.

### Subagent 호출

```
Task tool:
  subagent_type: plan-implementation
  model: haiku
  prompt: |
    [사용자 요청]
    [Phase 2 요구사항]
    [Phase 3 사용자 여정 - 해당시]
    [Phase 4 비즈니스 규칙 - 해당시]

    다음 구현 계획을 수립해주세요:

    ### 1. 목표
    [요구사항을 간결하게 요약]

    ### 2. 기술적 결정
    - 프레임워크/라이브러리 선택과 이유
    - 아키텍처 패턴
    - 데이터 구조

    ### 3. 작업 분해

    병렬 가능한 작업은 같은 배치로:

    **배치 1** (병렬 가능):
    - [ ] 작업 1.1: [파일] [변경 내용]
    - [ ] 작업 1.2: [파일] [변경 내용]

    **배치 2** (배치 1 완료 후):
    - [ ] 작업 2.1: [파일] [변경 내용]

    ### 4. 파일 변경 예상

    | 파일 | 변경 내용 | 이유 |
    |------|----------|------|

    ### 5. 리스크

    | 리스크 | 확률 | 영향 | 대응책 |
    |--------|------|------|--------|
```

### 작업 분해 원칙

**Superpowers 패턴**: 각 작업은 **2-5분**에 완료 가능해야 함

```markdown
❌ 나쁜 예:

- [ ] 인증 시스템 구현

✅ 좋은 예:

- [ ] User 타입 정의 (src/types/user.ts)
- [ ] 로그인 API 엔드포인트 추가 (src/api/auth.ts)
- [ ] JWT 토큰 생성 함수 (src/utils/jwt.ts)
- [ ] 로그인 폼 컴포넌트 (src/components/LoginForm.tsx)
- [ ] 로그인 상태 관리 (src/store/auth.ts)
```

### 출력 형식

```markdown
## 구현 계획

### 목표

[요구사항 1-2줄 요약]

### 기술적 결정

- **프레임워크**: React + TypeScript
- **상태 관리**: React Context
- **API 클라이언트**: axios
- **이유**: [선택 근거]

### 작업 분해

#### 배치 1 (병렬 가능)

- [ ] 타입 정의: src/types/auth.ts
- [ ] API 함수: src/api/auth.ts
- [ ] 유틸리티: src/utils/jwt.ts

#### 배치 2 (배치 1 완료 후)

- [ ] 컴포넌트: src/components/LoginForm.tsx
- [ ] 상태 관리: src/store/auth.ts

#### 배치 3 (배치 2 완료 후)

- [ ] 페이지 통합: src/pages/login.tsx
- [ ] 테스트: src/**tests**/auth.test.ts

### 파일 변경 예상

| 파일                | 변경 | 이유          |
| ------------------- | ---- | ------------- |
| src/types/auth.ts   | 생성 | 타입 정의     |
| src/api/auth.ts     | 생성 | API 호출      |
| src/pages/login.tsx | 수정 | 컴포넌트 추가 |

### 리스크

| 리스크        | 확률 | 영향 | 대응책          |
| ------------- | ---- | ---- | --------------- |
| API 스펙 변경 | 중   | 중   | 인터페이스 분리 |
| 타입 불일치   | 낮   | 낮   | 테스트 커버리지 |
```

---

## Planning 완료 기준

### 필수 조건 (모든 규모)

```
✅ P0 모호함 = 0개
✅ 핵심 요구사항이 명확히 정의됨
✅ 영향 범위가 식별됨
✅ 리스크가 분석됨
```

### 추가 조건 (Medium 이상)

```
✅ 사용자 여정이 정의됨
✅ 주요 상태 전이가 명세됨
✅ 에러 처리 전략이 수립됨
```

### 추가 조건 (Large)

```
✅ 비즈니스 규칙이 명세됨
✅ 규칙 간 관계가 정의됨
✅ 예외 처리가 명세됨
```

---

## 참고

- Superpowers 패턴: docs/research/superpowers-analysis.md
- Planning 협업: .claude/rules/planning-protocol.md
- Agent 시스템: .claude/rules/agent-system.md

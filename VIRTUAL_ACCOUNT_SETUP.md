# 한국투자증권 가상계좌 초기 설정 가이드

## ⚠️ 중요: 자동 매매 시작 전 필수 설정

자동 매매 시스템이 작동하려면 **가상계좌에 초기 자금이 설정**되어 있어야 합니다.

## 📋 문제 증상

- 스케줄러는 정상 실행 중
- 일일 선정 종목도 정상 생성
- **하지만 매매가 실행되지 않음**

**원인**: 가상계좌 잔고가 0원

## 🔧 해결 방법

### 1단계: 한국투자증권 모의투자 사이트 접속

```
https://securities.koreainvestment.com
```

1. 웹브라우저에서 위 URL 접속
2. 로그인

### 2단계: 모의투자 계좌 설정

1. **상단 메뉴**에서 `모의투자` 클릭
2. `모의투자 신청/조회` 메뉴로 이동
3. 계좌 정보 확인

### 3단계: 초기 자금 설정

**옵션 A: 새로운 계좌 생성** (권장)
1. `모의투자 신청` 클릭
2. 약관 동의
3. 초기 자금 입력: **100,000,000원 (1억원)** 권장
4. 신청 완료

**옵션 B: 기존 계좌 초기화**
1. `나의 모의투자 계좌` 클릭
2. `계좌 초기화` 버튼 클릭
3. 초기 자금 입력: **100,000,000원 (1억원)** 권장
4. 초기화 확인

### 4단계: 계좌 정보 확인

설정 완료 후, 다음 명령으로 확인:

```bash
python tests/test_kis_virtual_account.py
```

**정상 출력 예시**:
```
💰 계좌 정보:
   - 예수금 (현금): 100,000,000원
   - 평가금액 (주식): 0원
   - 총자산: 100,000,000원

✅ 가상계좌 정상 - 자동 매매 가능
```

## 💡 초기 자금 권장 금액

| 목적 | 권장 금액 | 설명 |
|------|----------|------|
| **기본 테스트** | 1억원 (100,000,000원) | 가장 일반적이고 안전한 금액 |
| 소규모 테스트 | 5천만원 (50,000,000원) | 최소 5-10개 종목 보유 가능 |
| 대규모 테스트 | 10억원 (1,000,000,000원) | 더 많은 종목과 큰 포지션 테스트 |

**현재 시스템 설정**:
- 최대 보유 종목: 10개
- 종목당 투자: 계좌의 10%
- 1억원 기준: 종목당 약 1,000만원

## 🚀 설정 완료 후

### 자동 매매 시작

초기 자금 설정이 완료되면 자동 매매가 다음 거래일부터 자동으로 시작됩니다:

**스케줄**:
- **09:00** - 자동 매매 시작 (평일만)
- **15:30** - 자동 매매 중지 (평일만)
- **16:00** - 일일 정리 작업

### 수동으로 즉시 테스트

거래일(평일) 장 시간(09:00-15:30)에 수동으로 테스트하려면:

```bash
python tests/test_trading_engine_direct.py
```

이 스크립트는:
1. API 연결 확인
2. 오늘의 선정 종목 로드
3. 매수 조건 확인
4. 실제 매수 주문 테스트 (사용자 확인 후)

## 📊 모니터링

### 계좌 상태 확인

```bash
# 계좌 잔고 및 보유 종목 확인
python tests/test_kis_virtual_account.py
```

### 매매 기록 확인

```bash
# 오늘의 매매 일지 확인
cat data/trades/trade_journal_$(date +%Y%m%d).json

# 오늘의 매매 요약 확인
cat data/trades/trade_summary_$(date +%Y%m%d).json
```

### 로그 확인

```bash
# 오늘의 시스템 로그
tail -f logs/$(date +%Y%m%d).log | grep -i "매매\|trading\|buy\|sell"
```

## ⚠️ 주의사항

### 1. 가상계좌 vs 실전계좌

현재 설정: **가상계좌 (virtual)**
- 안전하게 테스트 가능
- 실제 돈이 사용되지 않음
- API 응답은 실전과 동일

확인 방법:
```python
from core.config.api_config import APIConfig
config = APIConfig()
print(config.server)  # "virtual" 이어야 함
```

### 2. 주말/공휴일

- 주말과 공휴일에는 자동 매매가 실행되지 않음
- 스케줄러는 계속 실행되지만 거래일만 매매 실행
- 마지막 일일 선정은 금요일 것을 사용

### 3. 장 시간

한국 주식시장 거래 시간:
- **장 시작**: 09:00
- **장 마감**: 15:30
- 자동 매매는 이 시간 동안만 실행

### 4. API 호출 제한

한국투자증권 API 제한:
- **초당 요청 제한**: 20건/초
- 시스템은 자동으로 간격 조절
- 과도한 호출 시 자동으로 대기

## 🔍 문제 해결

### 문제 1: "계좌 잔고가 0원입니다"

**해결**: 위 1-3단계 다시 실행

### 문제 2: "일일 선정 파일이 없습니다"

**원인**:
- 오늘이 주말/공휴일
- Phase 2가 아직 실행되지 않음

**해결**:
```bash
# 수동으로 일일 선정 실행
python workflows/phase2_daily_selection.py update
```

### 문제 3: "토큰 발급 실패"

**원인**: API 키 설정 문제

**해결**:
```bash
# API 설정 확인
cat config/api_config.json

# 필요시 재설정
# app_key, app_secret, account_number 확인
```

### 문제 4: "매수 주문 실패"

**가능한 원인**:
1. 시간외 거래 시도 (장 마감 후)
2. 주문 가격이 호가 단위에 맞지 않음
3. 거래 정지 종목

**해결**:
- 로그 확인: `logs/$(date +%Y%m%d).log`
- 오류 메시지 확인
- 필요시 해당 종목 제외

## 📱 텔레그램 알림

초기 자금 설정 후 매매가 시작되면 텔레그램으로 알림을 받습니다:

**매매 시작 알림**:
```
🚀 자동 매매 시작

⏰ 시작 시간: 09:00:15
🏦 계좌 유형: virtual
📊 설정 정보:
• 최대 보유 종목: 10개
• 종목당 투자금: 10.0%
• 손절매: 5.0%
• 익절매: 10.0%
```

**매수 체결 알림**:
```
💰 자동 매수 체결

종목: 삼성전자 (005930)
수량: 100주
매수가: 70,000원

투자금액: 7,000,000원
```

## ✅ 체크리스트

설정을 완료하기 전에 다음 항목을 확인하세요:

- [ ] 한국투자증권 모의투자 계좌 생성
- [ ] 초기 자금 설정 (권장: 1억원)
- [ ] `test_kis_virtual_account.py` 실행하여 잔고 확인
- [ ] 총자산이 0원이 아닌지 확인
- [ ] 서버 설정이 "virtual"인지 확인
- [ ] 스케줄러가 실행 중인지 확인 (`ps aux | grep integrated_scheduler`)
- [ ] 텔레그램 알림 설정 완료 (`config/telegram_config.json`)

## 🎯 다음 단계

초기 설정이 완료되면:

1. **거래일 대기**: 다음 거래일(평일)까지 대기
2. **자동 실행**: 09:00에 자동으로 매매 시작
3. **모니터링**: 텔레그램 알림 및 로그 확인
4. **성과 확인**: 16:00 이후 일일 리포트 확인

## 📚 추가 문서

- [전체 시스템 설명서](README.md)
- [알고리즘 업그레이드 요약](ALGORITHM_UPGRADE_SUMMARY.md)
- [ML 자동 트리거](ML_AUTO_TRIGGER_SUMMARY.md)

## 🆘 도움이 필요하신가요?

문제가 계속되면:
1. 로그 파일 확인: `logs/$(date +%Y%m%d).log`
2. 테스트 스크립트 재실행
3. GitHub Issues에 문의

---

**마지막 업데이트**: 2025-10-04
**시스템 버전**: 1.0.0

name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      target:
        description: "Deploy target"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - api-server
          - scheduler

env:
  DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
  DEPLOY_PATH: /opt/hantu_quant

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # CI 성공 시에만 배포 (workflow_dispatch는 항상 허용)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        id: deploy
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'ENDSSH'
            set -e  # 에러 발생 시 즉시 중단

            cd /opt/hantu_quant

            echo "=== Server Git Status Check ==="
            CURRENT_BRANCH=$(git branch --show-current)
            echo "Current branch: $CURRENT_BRANCH"

            # Check: Uncommitted changes
            if [ -n "$(git status --porcelain)" ]; then
              echo "⚠️ Uncommitted changes detected, stashing..."
              git stash push -m "auto-stash-before-deploy-$(date +%Y%m%d-%H%M%S)"
            fi

            # Switch to main (with verification)
            echo "=== Switching to main branch ==="
            git fetch origin main
            git checkout main

            # Verify we're on main before reset
            if [ "$(git branch --show-current)" != "main" ]; then
              echo "❌ ERROR: Failed to checkout main branch!"
              exit 1
            fi

            git reset --hard origin/main
            COMMIT_SHA=$(git rev-parse --short HEAD)
            echo "✅ Now on main branch: $COMMIT_SHA"

            # Run pre-deployment checks (after git pull to ensure scripts exist)
            echo "=== Running Pre-deployment Checks ==="
            chmod +x scripts/deployment/*.sh
            source scripts/deployment/pre_checks.sh
            if ! run_pre_deployment_checks; then
              echo "❌ Pre-deployment checks failed!"
              exit 1
            fi
            echo "✅ Pre-deployment checks passed"

            # Install dependencies (--quiet 제거하여 오류 확인 가능)
            echo "=== Installing dependencies ==="
            source venv/bin/activate
            pip install -r requirements.txt
            if [ $? -ne 0 ]; then
              echo "❌ ERROR: pip install failed!"
              python scripts/deployment/log_deploy_error.py \
                --service "dependencies" \
                --message "pip install 실패" \
                --telegram \
                --commit "$COMMIT_SHA" \
                --branch "main" || true
              exit 1
            fi
            echo "✅ Dependencies installed"

            # Run database migrations (if needed)
            echo "=== Database migration ==="
            python -c "from core.database.session import DatabaseSession; db = DatabaseSession(); print('DB schema updated')"
            if [ $? -ne 0 ]; then
              echo "⚠️ WARNING: DB migration had issues, continuing..."
            fi

            # Restart API server
            echo "=== Restarting API server ==="
            sudo systemctl restart hantu-api
            sleep 5
            if ! systemctl is-active --quiet hantu-api; then
              echo "❌ ERROR: API server failed to start!"
              API_LOG=$(journalctl -u hantu-api -n 50 --no-pager 2>&1)
              echo "$API_LOG"
              python scripts/deployment/log_deploy_error.py \
                --service "api-server" \
                --message "API 서버 시작 실패" \
                --log "$API_LOG" \
                --telegram \
                --commit "$COMMIT_SHA" \
                --branch "main" || true
              exit 1
            fi
            echo "✅ API server is running"

            # Restart Scheduler (더 긴 대기시간 필요)
            echo "=== Restarting Scheduler ==="
            sudo systemctl restart hantu-scheduler
            
            # 스케줄러 초기화에 시간이 더 필요 (15초 대기)
            echo "Waiting for scheduler initialization (15s)..."
            sleep 15
            
            if ! systemctl is-active --quiet hantu-scheduler; then
              echo "❌ ERROR: Scheduler failed to start!"
              SCHEDULER_LOG=$(journalctl -u hantu-scheduler -n 50 --no-pager 2>&1)
              echo "$SCHEDULER_LOG"
              python scripts/deployment/log_deploy_error.py \
                --service "scheduler" \
                --message "스케줄러 시작 실패" \
                --log "$SCHEDULER_LOG" \
                --telegram \
                --commit "$COMMIT_SHA" \
                --branch "main" || true
              exit 1
            fi
            echo "✅ Scheduler is running"

            # Setup auto-fix crontab
            echo "=== Setting up auto-fix crontab ==="
            chmod +x scripts/setup-crontab.sh
            bash scripts/setup-crontab.sh || echo "⚠️ Crontab setup had issues, continuing..."

            # Final verification
            echo "=== Final Service Status ==="
            systemctl status hantu-api --no-pager -l | head -20
            systemctl status hantu-scheduler --no-pager -l | head -20

            echo ""
            echo "✅ Deployment complete! Commit: $COMMIT_SHA"
          ENDSSH

      - name: Track Deployment Status
        if: always()
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'ENDSSH'
            set +e  # Don't exit on error in tracking

            cd /opt/hantu_quant

            # Source state manager
            source scripts/deployment/state_manager.sh

            # Determine deployment outcome (check if previous step succeeded)
            # Note: In SSH context, we check service status as proxy for deployment success
            if systemctl is-active --quiet hantu-api && systemctl is-active --quiet hantu-scheduler; then
              echo "Deployment succeeded - updating state"
              update_state "success" "Deployed $(git rev-parse --short HEAD)"
            else
              echo "Deployment failed - updating state"
              COMMIT_SHA=$(git rev-parse --short HEAD)
              BRANCH=$(git branch --show-current)

              update_state "failed" "Deployment failed: services not running"

              # Check consecutive failures
              FAILURES=$(get_consecutive_failures)
              echo "Consecutive failures: $FAILURES"

              if [ "$FAILURES" -ge 2 ]; then
                echo "Sending deployment failure alert..."
                LAST_SUCCESS=$(get_last_success)
                python3 scripts/deployment/send_failure_alert.py "$FAILURES" "$COMMIT_SHA" "$BRANCH" "$LAST_SUCCESS" || echo "Failed to send Telegram alert"
              fi
            fi
          ENDSSH

      - name: Health Check
        if: success()
        run: |
          echo "Waiting for services to stabilize (10s)..."
          sleep 10

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.DEPLOY_HOST }}:8000/health || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ Health check passed (HTTP $HTTP_STATUS)"
          else
            echo "⚠️ Health check returned HTTP $HTTP_STATUS"
            # 실패해도 배포는 완료된 상태이므로 warning만 출력
          fi

      - name: Send Telegram Notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          COMMIT_SHA: ${{ github.sha }}
          JOB_STATUS: ${{ job.status }}
        run: |
          if [ "$JOB_STATUS" = "success" ]; then
            EMOJI="✅"
            MESSAGE="배포 성공"
          else
            EMOJI="❌"
            MESSAGE="배포 실패"
          fi

          TEXT="$EMOJI *한투 퀀트 배포 알림*

          *상태*: $MESSAGE
          *브랜치*: main
          *커밋*: ${COMMIT_SHA:0:7}
          *시간*: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S')"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "parse_mode=Markdown" \
            -d "text=${TEXT}" || true

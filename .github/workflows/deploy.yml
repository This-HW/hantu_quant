name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      target:
        description: "Deploy target"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - api-server
          - scheduler

env:
  DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
  DEPLOY_PATH: /opt/hantu_quant

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # CI 성공 시에만 배포 (workflow_dispatch는 항상 허용)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'ENDSSH'
            set -e  # 에러 발생 시 즉시 중단

            cd ${{ env.DEPLOY_PATH }}

            echo "=== Server Git Status Check ==="
            CURRENT_BRANCH=$(git branch --show-current)
            echo "Current branch: $CURRENT_BRANCH"

            # Check: Uncommitted changes
            if [ -n "$(git status --porcelain)" ]; then
              echo "⚠️ Uncommitted changes detected, stashing..."
              git stash push -m "auto-stash-before-deploy-$(date +%Y%m%d-%H%M%S)"
            fi

            # Switch to main (with verification)
            echo "=== Switching to main branch ==="
            git fetch origin main
            git checkout main

            # Verify we're on main before reset
            if [ "$(git branch --show-current)" != "main" ]; then
              echo "❌ ERROR: Failed to checkout main branch!"
              exit 1
            fi

            git reset --hard origin/main
            echo "✅ Now on main branch: $(git rev-parse --short HEAD)"

            # Install dependencies
            source venv/bin/activate
            pip install -r requirements.txt --quiet

            # Run database migrations (if needed)
            python -c "from core.database.session import DatabaseSession; db = DatabaseSession(); print('DB schema updated')"

            # Restart services
            sudo systemctl restart hantu-api
            sudo systemctl restart hantu-scheduler

            # Verify services
            sleep 5
            systemctl is-active hantu-api || echo "API server not running"
            systemctl is-active hantu-scheduler || echo "Scheduler not running"

            echo "Deployment complete!"
          ENDSSH

      - name: Health Check
        run: |
          sleep 10
          curl -f http://${{ secrets.DEPLOY_HOST }}:8000/health || echo "Health check failed"

      - name: Send Telegram Notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          COMMIT_SHA: ${{ github.sha }}
          JOB_STATUS: ${{ job.status }}
        run: |
          if [ "$JOB_STATUS" = "success" ]; then
            EMOJI="✅"
            MESSAGE="배포 성공"
          else
            EMOJI="❌"
            MESSAGE="배포 실패"
          fi

          TEXT="$EMOJI *한투 퀀트 배포 알림*

          *상태*: $MESSAGE
          *브랜치*: main
          *커밋*: ${COMMIT_SHA:0:7}
          *시간*: $(date '+%Y-%m-%d %H:%M:%S')"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "parse_mode=Markdown" \
            -d "text=${TEXT}" || true
